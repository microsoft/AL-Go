name: Comment on Existing Release Notes PRs

on:
  workflow_dispatch:
    inputs:
      dryRun:
        description: 'Dry run mode (only list PRs, do not add comments)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  pull-requests: write
  contents: read
  issues: write

jobs:
  comment-on-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Add Comments to Existing PRs
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const dryRun = '${{ inputs.dryRun }}' === 'true';
            
            // PRs that modify RELEASENOTES.md
            const prs = [2056, 2049, 2048, 2047, 2041, 2033, 2031, 2029, 2010, 1994, 1882, 1828, 1824, 1795];
            
            // Read RELEASENOTES.md to detect current version
            let currentVersion;
            try {
              const releaseNotes = fs.readFileSync('RELEASENOTES.md', 'utf8');
              const versionMatch = releaseNotes.match(/^##\s*v(\d+\.\d+(?:\.\d+)?)/m);
              if (versionMatch) {
                currentVersion = 'v' + versionMatch[1];
                console.log('Detected current version: ' + currentVersion);
              } else {
                throw new Error("Could not detect version from RELEASENOTES.md. Expected to find a line matching '## vX.Y' or '## vX.Y.Z'");
              }
            } catch (error) {
              console.error('Error reading version from RELEASENOTES.md: ' + error.message);
              throw error;
            }
            
            const comment = `### ⚠️ Release Notes Update Reminder

Thank you for updating the release notes! 

Please ensure that your changes are placed **above the new version section** (currently \`## ${currentVersion}\`) in the RELEASENOTES.md file.

This helps maintain a clear changelog structure where new changes are grouped under the latest unreleased version.`;
            
            console.log(`Processing ${prs.length} PRs...`);
            console.log(`Dry run mode: ${dryRun}`);
            console.log('');
            
            let commented = 0;
            let skipped = 0;
            let failed = 0;
            
            for (const prNumber of prs) {
              try {
                console.log(`Checking PR #${prNumber}...`);
                
                // Check if comment already exists
                const comments = await github.rest.issues.listComments({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                });
                
                const alreadyCommented = comments.data.some(c => 
                  c.body && c.body.includes('Release Notes Update Reminder')
                );
                
                if (alreadyCommented) {
                  console.log(`  ℹ️ Comment already exists on PR #${prNumber}, skipping...`);
                  skipped++;
                  continue;
                }
                
                if (dryRun) {
                  console.log(`  [DRY RUN] Would add comment to PR #${prNumber}`);
                  commented++;
                } else {
                  // Add comment
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: prNumber,
                    body: comment
                  });
                  console.log(`  ✓ Comment added to PR #${prNumber}`);
                  commented++;
                }
              } catch (error) {
                console.log(`  ✗ Failed to process PR #${prNumber}: ${error.message}`);
                failed++;
              }
            }
            
            console.log('');
            console.log('Summary:');
            console.log(`  Total PRs processed: ${prs.length}`);
            console.log(`  Comments added: ${commented}`);
            console.log(`  Skipped (already commented): ${skipped}`);
            console.log(`  Failed: ${failed}`);
